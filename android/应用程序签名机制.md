
https://www.jianshu.com/p/286d2b372334

https://segmentfault.com/a/1190000012780434

https://juejin.cn/post/6844903557037047815


#### 签名解决的问题
 一是要确保apk来源的真实性，二是确保apk没有被篡改；
  
 #### 签名流程
 APK文件根目录下有个META-INF目录，该目录下会有以下三个文件：
 ```
MANIFEST.MF
CERT.SF
CERT.RSA
```
 
  - MANIFEST.MF
    遍历apk中所有条目，如果是目录跳过，如果是一个文件，就用消息摘要算法(SHA1或SHA256)+Base64编码生成内容，作为属性写入到MANIFEST.MF文件中，其中Name为文件路径
	
  - CERT.SF
     1. 记录MANIFEST.MF头部块消息摘要+Base64编码内容
	 2. 记录整个MANIFEST.MF文件消息摘要+Base64编码内容
	 3. 记录MANIFEST.MF中的每个条目消息摘要+Base64编码内容

  - CERT.RSA
    之前生成的CERT.SF文件，用私钥计算出签名，然后将该签名和包含公钥的数字证书一通写入到CERT.RSA中
	
	- 自签名证书
	 即自己颁给自己的证书，公钥证书的Issuer(发布者)和Subject(所有者)是相同的

#### 验证流程
   验证顺序：apk –> MANIFEST.MF –> CERT.SF
  - 检查api中所有文件，每个文件摘要值与MANIFEST.MF文件中记录值是否一致
  - 使用证书文件(RSA文件)检验签名文件(SF文件)有没有被篡改过
  - 使用签名文件(SF文件）检验MF文件有没有被篡改过

#### 问题
可以把apk内容和签名信息一同篡改，这相当于对apk进行了重新签名，在apk没有安装到系统中的情况下，是可以正常安装的，覆盖安装会失败。

#### 签名机制演进
  1. V1
   - 第一代是基于JAR文件签名，它主要缺陷是保护了一部分文件。因为有些文件不可能为自己签名然后再把签名信息保存到自己内部，因此第一代签名机制会忽略.SF、.RSA、.DSA以及MEAT-INFO目录下的所有文件；如此攻击者就可以解压缩api后，在META-INF新增文件，然后再压缩成APK，同样可以覆盖正版应用。
   - 另外，应用安装起来也比较慢，因为安装器在校验时需要解压计算所有文件的数字摘要。

  2. V2
   - 将APK文件作为一个整体，值校验APK文件的签名就可以了；
   - APK本质上是zip格式的，V1方案需要修改数据区和中央目录，而V2是在数据区和中央目录之间插入一个APK签名块，从而保证apk数据的完整性
![[Pasted image 20210516213053.png]]

